<div class="project-new">
  <!-- Animated Background -->
  <div class="animated-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-overlay"></div>
    <div class="particles">
      @for (i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]; track i) {
        <div class="particle" [style.--delay]="i * 0.3 + 's'" [style.--x]="(i * 17) % 100 + '%'"></div>
      }
    </div>
  </div>

  <!-- Hero Section -->
  <section class="hero" [class.typed]="heroTyped()">
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">
          <span class="line-1">{{ typewriterText1() }}<span class="cursor" [class.visible]="showCursor1()">|</span></span>
          <span class="line-2 gradient-text">{{ typewriterText2() }}<span class="cursor" [class.visible]="showCursor2()">|</span></span>
        </h1>
        <p class="hero-subtitle" [class.visible]="subtitleVisible()">
          Tehisintellekt anal√º√ºsib sinu projekti, tuvastab k√µik ehitusetapid,<br>
          leiab √ºle <strong>{{ totalSupplierCount() | number }}</strong> tegija ja arvutab turuhinna ‚Äî <em>sekunditega.</em>
        </p>
      </div>
    </div>
  </section>

  <!-- Input Section -->
  @if (!result()) {
    <section class="input-section">
      <div class="container">
        <div class="glass-card input-card" [class.loading]="isLoading()">
          <!-- Textarea -->
          <div class="textarea-wrapper">
            <textarea
              #textarea
              [ngModel]="description()"
              (ngModelChange)="description.set($event)"
              [placeholder]="currentPlaceholder()"
              [disabled]="isLoading()"
              rows="5"
              class="glass-textarea"
            ></textarea>
            <div class="word-count">{{ wordCount() }} s√µna</div>
          </div>

          <!-- File Upload Zone -->
          <div
            class="upload-zone"
            [class.drag-over]="isDragOver()"
            [class.has-file]="selectedFiles().length > 0"
            (dragenter)="onDragEnter($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="triggerFileInput()"
          >
            <input
              #fileInput
              type="file"
              accept=".pdf,.docx,.doc,.txt,.jpg,.jpeg,.png,.gif,.bmp,.webp,.ifc,.dwg,.dxf,.rvt,.zip"
              (change)="onFileSelected($event)"
              multiple
              hidden
            >

            @if (selectedFiles().length === 0) {
              <div class="upload-content">
                <div class="upload-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                </div>
                <p class="upload-text">Lohista failid siia v√µi <span>kliki</span></p>
                <p class="upload-formats">PDF, DOCX, DWG, DXF, IFC, RVT, ZIP, JPG, PNG</p>
                <div class="format-icons">
                  <span class="format-badge bim" title="BIM/IFC mudel">üèóÔ∏è IFC</span>
                  <span class="format-badge cad" title="AutoCAD joonis">üìê DWG</span>
                  <span class="format-badge cad" title="CAD joonis">üìè DXF</span>
                  <span class="format-badge bim" title="Revit mudel">üèõÔ∏è RVT</span>
                  <span class="format-badge doc" title="Dokumendid">üìÑ PDF</span>
                  <span class="format-badge img" title="Pildid">üñºÔ∏è IMG</span>
                  <span class="format-badge zip" title="ZIP arhiiv">üì¶ ZIP</span>
                </div>
                <p class="zip-hint">Saad lisada mitu faili korraga</p>
              </div>
            } @else {
              <div class="files-list" (click)="$event.stopPropagation()">
                <div class="files-header">
                  <span class="files-count">{{ selectedFiles().length }} faili ({{ (getTotalFileSize() / 1024) | number:'1.0-0' }} KB)</span>
                  <button class="btn-add-more" (click)="triggerFileInput(); $event.stopPropagation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Lisa veel
                  </button>
                </div>
                @for (file of selectedFiles(); track file.name) {
                  <div class="file-row">
                    @if (getFilePreview(file)) {
                      <img [src]="getFilePreview(file)" alt="Preview" class="file-row-preview">
                    } @else {
                      <span class="file-row-icon">{{ getFileIcon(file.name) }}</span>
                    }
                    <div class="file-row-info">
                      <span class="file-row-name">{{ file.name }}</span>
                      <span class="file-row-meta">{{ getFileTypeLabel(file.name) }} ‚Äî {{ (file.size / 1024) | number:'1.0-0' }} KB</span>
                    </div>
                    <button class="file-remove-small" (click)="removeFile(file); $event.stopPropagation()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Error Message -->
          @if (error()) {
            <div class="error-message">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              {{ error() }}
            </div>
          }

          <!-- Upload Progress -->
          @if (isUploading() && uploadProgress()) {
            <div class="upload-progress-section">
              @if (uploadProgress()?.phase === 'uploading') {
                <div class="upload-progress-header">
                  <span class="upload-status">Laadin √ºles: {{ uploadProgress()?.progress }}%</span>
                  <span class="upload-stats">{{ formatSpeed(uploadProgress()?.speed || 0) }} ‚Äî ~{{ formatTime(uploadProgress()?.remainingTime || 0) }} j√§√§nud</span>
                </div>
                <div class="upload-progress-bar">
                  <div class="progress-fill" [style.width.%]="uploadProgress()?.progress"></div>
                </div>
                <div class="upload-size-info">
                  {{ formatFileSize(uploadProgress()?.loaded || 0) }} / {{ formatFileSize(uploadProgress()?.total || 0) }}
                </div>
              }

              <!-- Processing Steps -->
              @if (uploadProgress()?.processingSteps) {
                <div class="processing-steps">
                  @for (step of uploadProgress()?.processingSteps; track step.label) {
                    <div class="processing-step" [class.done]="step.status === 'done'" [class.active]="step.status === 'active'">
                      @if (step.status === 'done') {
                        <span class="step-icon done">‚úì</span>
                      } @else if (step.status === 'active') {
                        <span class="step-icon active">
                          <svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/>
                          </svg>
                        </span>
                      } @else {
                        <span class="step-icon pending">‚óã</span>
                      }
                      <span class="step-label">{{ step.label }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- CTA Button -->
          <button
            class="cta-button"
            [class.loading]="isLoading()"
            (click)="parseProject()"
            [disabled]="isLoading()"
          >
            @if (isLoading()) {
              <div class="loading-content">
                <div class="brain-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v8a6 6 0 0 0 12 0v-8a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"/>
                    <circle cx="9" cy="13" r="1"/><circle cx="15" cy="13" r="1"/>
                    <path d="M9 17h6"/>
                  </svg>
                </div>
                <span class="loading-text">{{ loadingText() }}</span>
              </div>
            } @else {
              <span class="button-text">Anal√º√ºsi projekti</span>
              <span class="button-sparkle">‚ú®</span>
            }
          </button>
        </div>

        <!-- Social Proof -->
        <div class="social-proof">
          <div class="proof-item">
            <div class="proof-number">{{ totalSupplierCount() | number }}</div>
            <div class="proof-label">Ehitusettev√µtet</div>
          </div>
          <div class="proof-divider"></div>
          <div class="proof-item">
            <div class="proof-number">12</div>
            <div class="proof-label">Kategooriat</div>
          </div>
          <div class="proof-divider"></div>
          <div class="proof-item">
            <div class="proof-number">10</div>
            <div class="proof-label">Linna</div>
          </div>
        </div>
      </div>
    </section>
  }

  <!-- Quantity Editor Section -->
  @if (result() && showQuantityEditor()) {
    <section class="quantity-editor-section">
      <div class="container">
        <div class="project-header glass-card">
          <div class="project-info">
            <span class="project-badge">AI Anal√º√ºs</span>
            <h2>{{ result()?.projectTitle }}</h2>
            <p class="project-location">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
              </svg>
              {{ result()?.location }}
            </p>
          </div>
          <button class="btn-secondary" (click)="resetForm()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Uus p√§ring
          </button>
        </div>

        <div class="quantity-editor glass-card">
          <div class="qty-editor-header">
            <h3>Kontrolli koguseid</h3>
            <p class="section-hint">AI tuvastas <strong>{{ result()?.stages?.length }}</strong> etappi. Muuda koguseid vastavalt vajadusele.</p>
          </div>

          <div class="work-items-table">
            <div class="table-header">
              <span class="col-desc">Etapp</span>
              <span class="col-qty">Kogus</span>
              <span class="col-unit">√úhik</span>
              <span class="col-cat">Kategooria</span>
            </div>

            @for (stage of result()?.stages; track stage.name; let i = $index) {
              <div class="table-row">
                <span class="col-desc">
                  <span class="stage-icon-inline">{{ getCategoryIcon(stage.category) }}</span>
                  {{ stage.name }}
                </span>
                <span class="col-qty">
                  <input
                    type="number"
                    [value]="stage.quantity"
                    (change)="updateQuantity(stage, $event)"
                    min="0.1"
                    step="0.1"
                    class="qty-input"
                  >
                </span>
                <span class="col-unit">{{ stage.unit }}</span>
                <span class="col-cat">
                  <span class="category-badge">{{ getCategoryLabel(stage.category) }}</span>
                </span>
              </div>
            }
          </div>

          <button
            class="cta-button"
            [class.loading]="isLoading()"
            (click)="confirmQuantities()"
            [disabled]="isLoading()"
          >
            @if (isLoading()) {
              <div class="loading-content">
                <div class="spinner"></div>
                <span>{{ loadingText() }}</span>
              </div>
            } @else {
              <span>Kinnita kogused ja arvuta hinnad</span>
              <span class="button-sparkle">‚ú®</span>
            }
          </button>
        </div>
      </div>
    </section>
  }

  <!-- Results Section -->
  @if (result() && !showQuantityEditor()) {
    <section class="results-section" [class.visible]="resultsVisible()">
      <div class="container">
        <!-- Project Header -->
        <div class="project-header glass-card">
          <div class="project-info">
            <span class="project-badge">AI Anal√º√ºs</span>
            <h2>{{ result()?.projectTitle }}</h2>
            <p class="project-location">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
              </svg>
              {{ result()?.location }}
            </p>
          </div>
          <div class="header-actions">
            <button class="btn-secondary" (click)="backToQuantityEditor()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Muuda koguseid
            </button>
            <button class="btn-secondary" (click)="resetForm()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
              Uus p√§ring
            </button>
          </div>
        </div>

        <!-- Tab Bar -->
        <div class="section-tabs">
          <button [class.active]="activeTab() === 'work'" (click)="setTab('work')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
            T√∂√∂d
          </button>
          <button [class.active]="activeTab() === 'materials'" (click)="setTab('materials')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
            Materjalid
            @if (dependentMaterialsCount() > 0) {
              <span class="tab-badge">{{ dependentMaterialsCount() }}</span>
            }
          </button>
          <button [class.active]="activeTab() === 'summary'" (click)="setTab('summary')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
              <line x1="3" y1="15" x2="21" y2="15"/>
              <line x1="9" y1="3" x2="9" y2="21"/>
            </svg>
            Koondtabel
          </button>
        </div>

        <!-- Work Tab -->
        @if (activeTab() === 'work') {
        <!-- Selection Controls -->
        <div class="selection-controls">
          <span class="stage-count">
            <span class="count-number">{{ result()?.stages?.length }}</span> etappi tuvastatud
          </span>
          <div class="control-buttons">
            <button class="btn-ghost" (click)="selectAll()">Vali k√µik</button>
            <button class="btn-ghost" (click)="deselectAll()">T√ºhista</button>
          </div>
        </div>

        <!-- Stages List -->
        <div class="stages-list">
          @for (stage of result()?.stages; track stage.name; let i = $index) {
            <div
              class="stage-card glass-card"
              [class.visible]="i < visibleCardCount()"
              [class.expanded]="stage.expanded"
              [class.selected]="stage.selected"
              [style.--delay]="i * 0.1 + 's'"
            >
              <!-- Connector Line -->
              @if (i > 0) {
                <div class="connector-line">
                  <div class="connector-dot"></div>
                  <div class="connector-path"></div>
                  <div class="connector-dot"></div>
                </div>
              }

              <div class="stage-header" (click)="toggleStage(stage)">
                <!-- Price Level Bar -->
                <div class="price-level-bar" [class]="getPriceLevel(stage)"></div>

                <!-- Checkbox -->
                <div class="stage-checkbox" (click)="toggleSelection(stage, $event)">
                  <div class="checkbox" [class.checked]="stage.selected">
                    @if (stage.selected) {
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    }
                  </div>
                </div>

                <!-- Icon -->
                <div class="stage-icon">{{ getCategoryIcon(stage.category) }}</div>

                <!-- Info -->
                <div class="stage-info">
                  <h3>{{ stage.name }}</h3>
                  <div class="stage-meta">
                    <span class="category-badge">{{ getCategoryLabel(stage.category) }}</span>
                    <span class="stage-qty">{{ stage.quantity }} {{ stage.unit }}</span>
                  </div>
                </div>

                <!-- Price & Suppliers -->
                <div class="stage-right">
                  <div class="stage-price">
                    {{ formatCurrency(stage.priceEstimateMin) }} ‚Äî {{ formatCurrency(stage.priceEstimateMax) }}
                    <span class="estimate-badge" *ngIf="stage.priceEstimateMin && stage.priceEstimateMax">hinnanguline</span>
                  </div>
                  <div class="supplier-count">
                    <span class="supplier-badge">
                      Leitud {{ stage.supplierCount }} tegijat
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </span>
                  </div>
                </div>

                <!-- Expand Arrow -->
                <div class="expand-arrow" [class.expanded]="stage.expanded">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
              </div>

              <!-- Expanded Content -->
              @if (stage.expanded) {
                <div class="stage-details">
                  <div class="detail-section">
                    <label>Kirjeldus</label>
                    <p>{{ stage.description }}</p>
                  </div>

                  <div class="detail-section">
                    <label>Turuhind</label>
                    <div class="price-bar-wrapper">
                      <div class="price-bar">
                        <div class="price-fill"></div>
                        <div class="price-median" [style.left.%]="getMedianPosition(stage)">
                          <div class="median-marker"></div>
                          <span class="median-label">{{ formatCurrency(stage.priceEstimateMedian) }}</span>
                        </div>
                      </div>
                      <div class="price-labels">
                        <span>{{ formatCurrency(stage.priceEstimateMin) }}</span>
                        <span>{{ formatCurrency(stage.priceEstimateMax) }}</span>
                      </div>
                    </div>
                  </div>

                  @if (stage.dependencies && stage.dependencies.length > 0) {
                    <div class="detail-section">
                      <label>S√µltuvused</label>
                      <div class="dependencies">
                        @for (dep of stage.dependencies; track dep) {
                          <span class="dep-badge">{{ dep }}</span>
                        }
                      </div>
                    </div>
                  }

                  <!-- Price Breakdown -->
                  <app-price-breakdown
                    [category]="stage.category"
                    [quantity]="stage.quantity"
                    [unit]="stage.unit"
                    [autoLoad]="true"
                  ></app-price-breakdown>
                </div>
              }
            </div>
          }
        </div>

        <!-- Pipe System Breakdown -->
        @if (hasPipeSystems()) {
          <div class="pipe-systems-wrapper glass-card">
            <app-pipe-system-breakdown
              [pipeSystems]="result()!.pipeSystems!"
            ></app-pipe-system-breakdown>
          </div>
        }

        <!-- Pipe Length Summary (colored pipes) -->
        @if (hasPipeLengths()) {
          <div class="pipe-lengths-wrapper glass-card">
            <app-pipe-length-summary
              [summaries]="result()!.pipeLengthSummaries!"
            ></app-pipe-length-summary>
          </div>
        }
        } <!-- end work tab -->

        <!-- Materials Tab -->
        @if (activeTab() === 'materials') {
          @if (hasPipeLengths()) {
            <div class="pipe-lengths-wrapper glass-card">
              <app-pipe-length-summary
                [summaries]="result()!.pipeLengthSummaries!"
              ></app-pipe-length-summary>
            </div>
          }
          <div class="materials-tab-content glass-card">
            <app-dependent-materials
              [materials]="result()?.dependentMaterials || []"
            ></app-dependent-materials>
          </div>
        }

        <!-- Summary Tab -->
        @if (activeTab() === 'summary') {
          <div class="summary-tab-content glass-card">
            <app-summary-table
              [stages]="result()?.stages || []"
              [materials]="result()?.dependentMaterials || []"
            ></app-summary-table>
          </div>
        }

        <!-- RFQ Success -->
        @if (rfqSent()) {
          <div class="rfq-success glass-card">
            <div class="success-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
            </div>
            <h2>Hinnap√§ringud saadetud!</h2>
            <p>Saatsime hinnap√§ringud <strong>{{ rfqSentCount() }}</strong> ettev√µttele.</p>
            <p class="success-note">Teavitame sind, kui pakkumised saabuvad.</p>
            <button class="cta-button" (click)="resetForm()">Alusta uut projekti</button>
          </div>
        }

        <!-- Summary Card -->
        @if (!rfqSent()) {
          <div class="summary-card glass-card">
            <div class="summary-content">
              <div class="summary-left">
                <div class="summary-label">T√∂√∂de maksumus</div>
                <div class="summary-price">
                  {{ formatCurrency(animatedTotalMin()) }} ‚Äî {{ formatCurrency(animatedTotalMax()) }}
                </div>
                @if (hasDependentMaterials()) {
                  <div class="summary-materials-line">
                    Materjalid: {{ formatCurrency(result()?.materialsTotalMin || 0) }} ‚Äî {{ formatCurrency(result()?.materialsTotalMax || 0) }}
                  </div>
                  <div class="summary-grand">
                    Kokku: {{ formatCurrency(result()?.grandTotalMin || 0) }} ‚Äî {{ formatCurrency(result()?.grandTotalMax || 0) }}
                  </div>
                }
              </div>
              <div class="summary-divider"></div>
              <div class="summary-right">
                <div class="summary-stat">
                  <div class="stat-number">{{ animatedSupplierCount() }}</div>
                  <div class="stat-label">tegijat leitud</div>
                </div>
                <div class="summary-stat">
                  <div class="stat-number">{{ selectedStages().length }}</div>
                  <div class="stat-label">etappi valitud</div>
                </div>
                @if (hasDependentMaterials()) {
                  <div class="summary-stat">
                    <div class="stat-number">{{ dependentMaterialsCount() }}</div>
                    <div class="stat-label">materjali</div>
                  </div>
                }
              </div>
            </div>

            @if (error()) {
              <div class="error-message">{{ error() }}</div>
            }

            <button
              class="cta-button full-width"
              [class.loading]="isSendingRfq()"
              (click)="openPreview()"
              [disabled]="selectedStages().length === 0 || isSendingRfq()"
            >
              @if (isSendingRfq()) {
                <div class="loading-content">
                  <div class="spinner"></div>
                  <span>Saadan hinnap√§ringuid...</span>
                </div>
              } @else {
                <span>Vaata √ºle ja saada hinnap√§ring</span>
                <span class="rocket">üëÅÔ∏è</span>
              }
            </button>
          </div>
        }
      </div>
    </section>
  }

  <!-- Preview Modal -->
  @if (showPreview()) {
    <div class="preview-overlay" (click)="closePreview()">
      <div class="preview-modal glass-card" (click)="$event.stopPropagation()">
        <div class="preview-header">
          <h2>Hinnap√§ringu √ºlevaade</h2>
          <button class="close-btn" (click)="closePreview()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div class="preview-content">
          <!-- Work Items Table -->
          <div class="preview-section">
            <h3>T√∂√∂d ja materjalid</h3>
            <p class="section-hint">Muuda koguseid vastavalt vajadusele</p>

            <div class="work-items-table">
              <div class="table-header">
                <span class="col-desc">Kirjeldus</span>
                <span class="col-qty">Kogus</span>
                <span class="col-unit">√úhik</span>
                <span class="col-cat">Kategooria</span>
              </div>

              @for (stage of selectedStages(); track stage.name) {
                <div class="table-row">
                  <span class="col-desc">{{ stage.name }}</span>
                  <span class="col-qty">
                    <input
                      type="number"
                      [value]="stage.quantity"
                      (change)="updateQuantity(stage, $event)"
                      min="0.1"
                      step="0.1"
                      class="qty-input"
                    >
                  </span>
                  <span class="col-unit">{{ stage.unit }}</span>
                  <span class="col-cat">
                    <span class="category-badge">{{ getCategoryLabel(stage.category) }}</span>
                  </span>
                </div>
              }
            </div>
          </div>

          <!-- Companies by Category -->
          <div class="preview-section">
            <h3>Ettev√µtted kategooriate kaupa</h3>
            <p class="section-hint">Vali ettev√µtted, kellele p√§ring saata</p>

            @if (loadingCompanies()) {
              <div class="loading-companies">
                <div class="spinner"></div>
                <span>Laadin ettev√µtteid...</span>
              </div>
            } @else {
              @for (catCompanies of previewCompanies(); track catCompanies.category; let catIdx = $index) {
                <div class="category-section">
                  <div class="category-header">
                    <span class="category-icon">{{ getCategoryIcon(catCompanies.category) }}</span>
                    <span class="category-name">{{ getCategoryLabel(catCompanies.category) }}</span>
                    <span class="selected-count">{{ getSelectedCompanyCount(catIdx) }}/{{ catCompanies.companies.length }} valitud</span>
                    <div class="category-actions">
                      <button class="btn-small" (click)="selectAllCompanies(catIdx)">Vali k√µik</button>
                      <button class="btn-small" (click)="deselectAllCompanies(catIdx)">T√ºhista</button>
                      <button class="btn-small btn-add" (click)="openAddCompanyModal(catCompanies.category)">+ Lisa</button>
                    </div>
                  </div>

                  <div class="companies-list">
                    @for (company of catCompanies.companies; track company.id; let compIdx = $index) {
                      <div class="company-item" [class.selected]="company.selected">
                        <label class="company-checkbox">
                          <input
                            type="checkbox"
                            [checked]="company.selected"
                            (change)="toggleCompanySelection(catIdx, compIdx)"
                          >
                          <span class="checkmark"></span>
                        </label>
                        <div class="company-info">
                          <span class="company-name">{{ company.companyName }}</span>
                          @if (company.city || company.county) {
                            <span class="company-location">{{ company.city || company.county }}</span>
                          }
                        </div>
                        @if (company.googleRating) {
                          <div class="company-rating">
                            <span class="star">‚≠ê</span>
                            <span>{{ company.googleRating }}</span>
                          </div>
                        }
                        @if (company.website) {
                          <a [href]="company.website" target="_blank" class="company-link" (click)="$event.stopPropagation()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                              <polyline points="15 3 21 3 21 9"/>
                              <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                          </a>
                        }
                      </div>
                    }

                    @if (catCompanies.companies.length === 0) {
                      <div class="no-companies">
                        Selles kategoorias ettev√µtteid ei leitud.
                        <button class="btn-small btn-add" (click)="openAddCompanyModal(catCompanies.category)">+ Lisa ettev√µte</button>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        </div>

        <div class="preview-footer">
          <div class="preview-summary">
            <span class="summary-item">
              <strong>{{ selectedStages().length }}</strong> etappi
            </span>
            <span class="summary-divider">|</span>
            <span class="summary-item">
              <strong>{{ getTotalSelectedCompanyCount() }}</strong> ettev√µtet
            </span>
          </div>

          @if (error()) {
            <div class="error-message small">{{ error() }}</div>
          }

          <div class="preview-actions">
            <button class="btn-secondary" (click)="closePreview()">Tagasi</button>
            <button
              class="cta-button"
              [class.loading]="isSendingRfq()"
              (click)="confirmAndSendRfq()"
              [disabled]="getTotalSelectedCompanyCount() === 0 || isSendingRfq()"
            >
              @if (isSendingRfq()) {
                <div class="loading-content">
                  <div class="spinner"></div>
                  <span>Saadan...</span>
                </div>
              } @else {
                <span>Saada p√§ringud</span>
                <span class="rocket">üöÄ</span>
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Add Company Modal -->
  @if (showAddCompanyModal()) {
    <div class="add-company-overlay" (click)="closeAddCompanyModal()">
      <div class="add-company-modal glass-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Lisa ettev√µte</h3>
          <button class="close-btn" (click)="closeAddCompanyModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div class="modal-content">
          <div class="form-group">
            <label>Ettev√µtte nimi *</label>
            <input
              type="text"
              [ngModel]="manualCompanyName()"
              (ngModelChange)="manualCompanyName.set($event)"
              placeholder="O√ú Ehitaja"
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label>E-post</label>
            <input
              type="email"
              [ngModel]="manualCompanyEmail()"
              (ngModelChange)="manualCompanyEmail.set($event)"
              placeholder="info@ettevote.ee"
              class="form-input"
            >
          </div>

          <div class="form-group">
            <label>Telefon</label>
            <input
              type="tel"
              [ngModel]="manualCompanyPhone()"
              (ngModelChange)="manualCompanyPhone.set($event)"
              placeholder="+372 5xx xxxx"
              class="form-input"
            >
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeAddCompanyModal()">T√ºhista</button>
          <button
            class="cta-button small"
            (click)="addManualCompany()"
            [disabled]="!manualCompanyName()"
          >
            Lisa ettev√µte
          </button>
        </div>
      </div>
    </div>
  }
</div>
